## 【開発指示書】AI経理エージェント フェーズ3：階層型エージェントアーキテクチャの実装

### 1. はじめに

#### 1.1. プロジェクトの現在地
フェーズ2までで、私たちは「監督エージェント（`planner`）」が単独で業務手順書を解釈し、汎用ツール群を動的に呼び出すことでタスクを遂行するプロトタイプを完成させました。これは、AIが自律的に計画を立てる能力を獲得した、重要なマイルストーンです。

#### 1.2. フェーズ3のゴール
本タスクでは、ロードマップの**フェーズ3**として、アーキテクチャを**「階層型エージェントモデル」**へと進化させます。これにより、単一のエージェントが全ての業務知識を持つ構造から、特定の業務に特化した**「専門家エージェント」**が協調して動作する、よりスケーラブルでメンテナンス性の高いシステムを構築します。

最終的なゴールは、AIエージェントが「データ照合」という業務領域において、手順書を渡すだけで様々なタスク（売掛金消込、在庫照合など）をこなせる汎用性を獲得することです。

### 2. 目指すアーキテクチャ：階層型エージェントモデル

フェーズ3では、以下の3層からなる階層型アーキテクチャを実装します。まずは実行の信頼性を担保するため、専門家エージェントは固定ロジックで実装します（A案）。

```mermaid
graph TD
    subgraph 監督エージェント (自律的)
        A1[手順書] --> B1(LLMプランナー);
        B1 --> C1{パラメータ抽出};
    end

    subgraph 専門家エージェント (固定的)
        D1[固定ロジック<br>+<br>汎用ワークフロー]
    end
    
    subgraph 汎用ツール群
        F1[csv_reader, matcher, etc.]
    end

    C1 -- 具体的な指示（パラメータ）を渡す --> D1;
    D1 -- 必要なツールを呼び出す --> F1
    F1 --> D1
    D1 --> E1[結果];

    style B1 fill:#cde4ff
    style D1 fill:#e6e6e6
```

* **監督エージェント**: 手順書を解釈し、「どの専門家に、どんな指示を出すか」という**パラメータを生成**する司令塔です。
* **専門家エージェント**: 特定業務（例：在庫照合）の実行責任者。監督からの指示に基づき、**決められた手順**で汎用ツールを呼び出します。
* **汎用ツール**: ファイル読み込みなど、単一機能を提供する部品です。

### 3. 実装タスク

上記アーキテクチャを実現するため、以下のタスクを実装してください。

#### 3.1. 「汎用照合ワークフロー」モジュールの実装
専門家エージェントの処理の共通部分を再利用するため、「読み込み→突合→検証→出力」のシーケンスを管理するテンプレートを実装します。

* **作成場所**: `src/workflows/generic_matching_workflow.py`
* **要件**:
    * 入力ファイルパス、突合キー、検証ルールなどの設定を外部から受け取れるように設計してください。
    * このワークフローは、具体的な検証ツール（例：`difference_validator`）を内部で固定せず、外部から**設定として注入（Dependency Injection）**できる柔軟な作りにしてください。

#### 3.2. 最初の「専門家エージェント」の開発
最初の専門家として`InventoryMatchingAgent`（在庫照合エージェント）を実装します。

* **作成場所**: `src/agents/inventory_matching_agent.py`
* **要件**:
    1.  タスク3.1で作成した**「汎用照合ワークフロー」を利用**してください。
    2.  監督エージェントから渡されるパラメータ（突合キー、許容誤差など）を解釈し、汎用ワークフローに適切な設定を渡す役割を担います。
    3.  在庫照合に固有の処理（もしあれば）をこのファイル内にカプセル化します。
    4.  最終的なアウトプット（在庫差異レポート）を生成して返します。

#### 3.3. 監督エージェント (`planner`) の強化
現在の`planner`を、専門家エージェントを呼び出せるように改修します。

* **修正対象**: `src/nodes.py` 内の `planner` 関数
* **要件**:
    1.  **パラメータ抽出能力の向上**: LLMプロンプトを改良し、手順書からより複雑なパラメータ（例：複数の検証ルールをまとめたJSON形式のオブジェクト）を抽出できるようにしてください。
    2.  **ルーティング機能の追加**: 手順書の内容を解釈し、タスクに応じて呼び出すべきコンポーネントを決定するロジックを追加してください。
        * 例：「在庫照合」というキーワードがあれば、`InventoryMatchingAgent`を呼び出す。
        * 将来的には複数の専門家エージェントから適切なものを選択できるように、拡張性を考慮してください。

#### 3.4. 汎用ツールボックスの拡充
在庫照合ユースケースで必要となる、新しい汎用ツールを追加します。

* **作成場所**: `src/tools/numeric_field_validator.py`
* **要件**:
    * 2つの数値を受け取り、その差が指定された**許容誤差（パーセンテージ）**の範囲内であるかを判定する関数を実装してください。
    * 入力: `(value1: float, value2: float, tolerance: float)`
    * 出力: `bool` （許容範囲内なら `True`）

### 4. 想定ファイル構成（フェーズ3完了時）

開発後のファイル構成は、以下のようになることを想定しています。

```
src/
├── agents/             # 【新規】専門家エージェントを格納
│   ├── __init__.py
│   └── inventory_matching_agent.py
├── nodes.py            # (改修) plannerの強化
├── state.py
├── tools/              # (追加) 汎用ツールの拡充
│   ├── ...
│   └── numeric_field_validator.py
├── workflows/          # 【新規】汎用ワークフローを格納
│   ├── __init__.py
│   └── generic_matching_workflow.py
└── workflow.py         # (改修) 新しいagentノードの追加と接続
```

### 5. 期待する成果物

* **検証シナリオの成功**:
    * 前回の議論で整理した「在庫データの棚卸照合」のユースケース（手順書、入力データ）を実行すると、以下の流れで処理が成功し、最終的に在庫差異レポートが出力されること。
        1.  監督エージェントが手順書からパラメータを抽出する。
        2.  監督エージェントが`InventoryMatchingAgent`を呼び出す。
        3.  `InventoryMatchingAgent`がタスクを完遂し、正しい結果ファイルが生成される。
* **コードの品質**:
    * 新しく作成・改修されたコードが、上記のファイル構成に準拠し、責務が適切に分離されていること。

---

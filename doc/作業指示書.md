## 【開発指示書】AI経理エージェント フェーズ2 プロトタイプ実装

### 1. はじめに

本タスクでは、AI経理エージェント開発ロードマップの**フェーズ2**として、**LLMによる動的プランニング**機能を導入したプロトタイプを実装します。

これは、事前に定義された固定フローを実行していたフェーズ1のAIを、**自ら業務手順を解釈し、実行計画を立てられるAI**へと進化させる、プロジェクトの重要なステップです。

### 2. プロジェクトの経緯と背景

#### 2.1. フェーズ1の成果

まず、前任者が達成したフェーズ1の成果を共有します。

* **達成事項:** 単一業務（売上債権の消込）を、**固定のワークフロー**で自動化するPoCを**LangGraph**を用いて実装しました。これにより、「ツール化」された各機能（CSV読み込み、データ突合など）が正常に連携することを技術的に証明しました。
* **アーキテクチャ:** 各ツールを「作業者」、LangGraphのグラフ定義を「固定ルートを指示する監督」と見立てた、クリーンなアーキテクチャを確立しました。
* **特筆事項:** ノードの内部処理において、LLMが突合キーを動的に推定する`key_name_detector` を先行して実装し、LLMコンポーネントの有効性を実証済みです。

#### 2.2. フェーズ2の目標

フェーズ1ではAIが**「各駅停車の電車」**のように決められた線路を走るだけでした。フェーズ2の目標は、AIを**「指令室」**へと進化させることです。

ユーザーの指示や手順書に基づき、**「次にどの駅（ツール）へ向かうべきか」を自ら判断し、動的に経路（ワークフロー）を組み立てる能力**を獲得させます。

### 3. アーキテクチャ設計：動的ルーティングへの進化

フェーズ1のグラフ構造をベースに、LLMによる動的プランニングを実現するため、以下のアーキテクチャ変更を行います。

#### 3.1. 「LLMプランナー」ノードの導入

グラフの心臓部として、新たに**「プランナー（Planner）」ノード**を導入します。このノードが「指令室」の役割を果たします。

* **責務:**
    1.  現在の`State`（作業状況）と利用可能な全ツールのリストを把握する。
    2.  これらを基にLLMへ「次に実行すべきツールは何か？」と問い合わせる。
    3.  LLMから返されたツール名（例: `"read_billing_file"`）を、後述のルーティング機構へ渡す。

#### 3.2. LangGraph「条件付きエッジ」による動的ルーティング

フェーズ1の固定的な`add_edge`による接続を廃止し、LangGraphが提供する**`add_conditional_edges`**を用いて、プランナーノードの判断に基づき処理を振り分ける**動的なルーティング機構**を構築します。

* **処理フローの概念図:**

    ```
    [ 開始 ]
       ↓
    [ LLMプランナー・ノード ] --(次に実行するツールを判断)--> [ ルーティング機構 ]
       ↑                                                        ↓
       |                                           (プランナーの指示に基づき分岐)
       |                                          ↙          ↓          ↘
       |                                 [ ツールA ]  [ ツールB ]  [ ツールC ]
       |                                         ↖          ↑          ↙
       `------------------------------------------(処理完了後、プランナーに戻る)
    ```

このループ構造（`Plan → Execute → Plan ...`）により、AIはタスクが完了するまで自律的に次の行動を選択し続けることができます。

### 4. 実装タスク

上記設計に基づき、以下のタスクを実装してください。

#### 4.1. `Planner`ノードの実装

* LLMに次の行動を決定させる`planner`関数を作成してください。
* **プロンプト設計が鍵となります。** LLMへの入力には最低限、以下の情報を含めてください。
    * **システムプロンプト:** 「あなたは優秀な経理担当アシスタントです。以下のツールと現在の状況を基に、次に実行すべき最適なツールを一つだけ選んでください。」
    * **利用可能なツールリスト:** `ツール定義.md` の「AI向け説明」を参考に、各ツールの機能説明をプロンプトに含めます。
    * **現在の状態:** `State`オブジェクトの内容を渡し、「今どのようなデータを持っているか」をLLMに伝えます。
* 関数の戻り値は、LLMが選択した**ツール名（文字列）**とします。タスク完了と判断した場合は、`"__end__"`のような特別な文字列を返すようにLLMに指示してください。

#### 4.2. グラフ構造の変更

* `workflow.py` を修正し、フェーズ1の固定エッジを削除します。
* 代わりに、`planner`ノードをグラフに追加し、そこから`add_conditional_edges`を使って各ツールノードへ処理を振り分けるロジックを実装してください。
* 各ツールノードの実行後は、必ず`planner`ノードに処理が戻るようにエッジを接続します。

#### 4.3. 新規ツール`human_validator`の実装

* ロードマップ に記載のある、人間への確認を求める新規ツール`human_validator`を`src/tools/`に実装してください。
* このツールは、処理を一時停止し、ユーザーにコンソール経由で「はい/いいえ」の入力を求め、その結果（`True/False`）を返す単純なもので構いません。
* **ツール定義書の例:**
    * **ツール名:** `human_validator`
    * **所属階層:** 検証・認知層
    * **AI向け説明:** 「処理の途中でAI自身の判断に自信がない場合や、重要なステップの前に最終承認が必要な場合に、ユーザーに確認を求める質問を投げかけるためのツール。ユーザーからの『はい/いいえ』の応答を返す。」
    * **入力パラメータ:**
        * `question_text: string` - ユーザーに表示する質問文 (例: '合計金額は15,000円でよろしいですか？')
    * **出力スキーマ:**
        * `answer: boolean` - ユーザーの応答 ('はい'ならTrue, 'いいえ'ならFalse)
* 将来的にはlanggraphのinterruptにてhuman in the loopを使いますが、現時点ではランダムではい/いいえを返答するようにしてください。

### 5. 期待する成果物

* ユーザーの初期指示（例：「この入金ファイルと請求ファイルを消込してください」）に基づき、LLMが動的に実行計画を立て、タスクを完了できるLangGraphアプリケーション。
* `human_validator`ツールがワークフローの途中で呼び出され、ユーザーの入力を待機し、その応答に応じて後続の処理が変化することを確認できるテストケース。

---


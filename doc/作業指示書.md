## 【開発指示書】AI経理エージェント フェーズ1 PoC実装

### 1. はじめに

本タスクでは、AI経理エージェント開発ロードマップの**フェーズ1 PoC**として、「売上債権の消込」業務を自動化するワークフローを実装します。

先日策定した**YAML詳細設計**をブループリント（設計図）とし、Pythonの**LangGraph**ライブラリを用いて、このワークフローを構築してください。

### 2. 背景と目的（The "Why"）

* **ロードマップ上の位置付け:** 今回実装するのは、将来の拡張を見据えた**最初の基礎**です。フェーズ1はあらかじめ決められた処理順序（固定フロー）を実行しますが、フェーズ2以降ではLLMが動的に処理順序を決定するようになります。このため、初期段階から拡張性の高い**LangGraph**を採用します。
* **アーキテクチャ思想:** 開発するツールは、ツール定義フレームワークに基づき、「作業者」として単一の責務を持つように設計されています。LangGraphで構築するグラフは、これらの作業者を束ねて仕事の流れを管理する**「監督」**の役割を担います。

### 3. 実装の詳細（The "How"）

添付の`YAML詳細設計`を参照し、以下のステップで実装を進めてください。

#### ステップ1：State（状態）オブジェクトの定義

* YAMLの`state`セクションで定義されているスキーマに基づき、グラフ全体でデータの受け渡しを行うための`State`クラスを定義してください。（`TypedDict`や`Pydantic`モデルの使用を推奨します。）
* この`State`オブジェクトが、ワークフローを通じて全ての情報を保持する「バケツ」の役割を果たします。

```python
# 例：Stateクラスの定義
from typing import TypedDict, List, Dict

class AppState(TypedDict):
    input_files: Dict[str, str]
    raw_deposit_data: List[Dict]
    matching_results: Dict
    # ... YAMLの定義に合わせて全て記述
```

#### ステップ2：各Node（処理）の実装

* YAMLの`nodes`セクションにリストされている各ノードを、Pythonの関数として実装してください。
* 各ノード関数は、引数として`State`オブジェクトを受け取り、`State`オブジェクトを返すようにします。
* **重要な点:** ノードの内部では、対応する「ツール」（独立したPython関数）を呼び出し、その結果で`State`を更新します。

```python
# 例：read_deposit_fileノードの実装
def read_deposit_file(state: AppState) -> AppState:
    print("---NODE: Reading Deposit File---")
    # 1. Stateから必要な情報を取得
    file_path = state["input_files"]["deposit"]

    # 2. 対応するツールを呼び出す
    data = csv_reader(file_path=file_path) # csv_readerは別で実装

    # 3. Stateを更新して返す
    state["raw_deposit_data"] = data
    return state
```

* `validate_and_sort_matches`ノードでは、内部で`difference_validator`ツールを**ループ処理で呼び出し**、結果を`reconciled_list`と`unreconciled_list`に振り分けるロジックを実装してください。これは「監督」の判断業務をコード化したものです。

#### ステップ3：Graph（グラフ）の構築

* `langgraph.graph.StateGraph`をインスタンス化し、ステップ2で作成したノード関数を`add_node`メソッドでグラフに追加します。
* YAMLの`edges`セクションの定義通りに、`add_edge`メソッドを使ってノード間を接続してください。フェーズ1では**全てが固定（無条件）のエッジ**です。
* `set_entry_point`で最初のノードを指定し、グラフの定義を完了させてください。

```python
# 例：グラフの構築
from langgraph.graph import StateGraph

workflow = StateGraph(AppState)

# ノードの追加
workflow.add_node("read_deposit_file", read_deposit_file)
workflow.add_node("read_billing_file", read_billing_file)
# ... 全てのノードを追加

# エッジの接続
workflow.set_entry_point("read_deposit_file")
workflow.add_edge("read_deposit_file", "read_billing_file")
# ... 全てのエッジを接続
```

#### ステップ4：コンパイルと実行

* `compile()`メソッドでグラフをコンパイルし、実行可能なアプリケーションを作成します。
* 初期値（入力ファイルのパス）を`State`に設定し、`invoke`メソッドでグラフを実行して、最終的なCSVファイルが生成されることを確認してください。

### 4. 成果物

* YAML設計に基づき、売上債権の消込処理を最後まで実行できるLangGraphアプリケーションのPythonコード。
* 各ツール（`csv_reader`等）の実装コード。

---

以上です。ご不明な点があれば、いつでも質問してください。このPoCはプロジェクトの重要な第一歩です。よろしくお願いします。